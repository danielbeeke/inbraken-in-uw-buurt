function array_values(a){var b=[],c="";if(a&&"object"==typeof a&&a.change_key_case)return a.values();for(c in a)b[b.length]=a[c];return b}$(function(){var a,b,c=moment().subtract("days",29),d=moment(),e="DD/MM/YYYY",f=0,g=0,h={},i={},j=[];L.Icon.Default.imagePath="/images";var k={init:function(){a=L.map("map",{attributionControl:!1,maxZoom:18}).setView([52.1,5],14),a.on("moveend",function(){k.update()}),L.control.locate().addTo(a);var f=L.Control.loading({separate:!0});a.addControl(f),b=new L.MarkerClusterGroup,new L.Control.GeoSearch({provider:new L.GeoSearch.Provider.Google,showMarker:!1,zoomLevel:14,position:"topright"}).addTo(a),$(".leaflet-control-geosearch").prependTo($("#filter-form > .form-group:first"));new L.Hash(a);$("#hide-content").click(function(){$("body").toggleClass("show-content")}),$("#leaflet-control-geosearch-qry").addClass("form-control").attr("placeholder","Zoek naar een plaats"),L.tileLayer("http://{s}.tilemill.studiofonkel.nl/style/{z}/{x}/{y}.png?id=tmstyle:///home/administrator/styles/dark.tm2").addTo(a),$("#reportrange").daterangepicker({opens:"left",ranges:{"Afgelopen 7 dagen":[moment().subtract("days",6),moment()],"Deze maand":[moment().startOf("month"),moment().endOf("month")],"Afgelopen 3 maanden":[moment().subtract("month",3).startOf("month"),moment().subtract("month",1).endOf("month")]},format:"DD/MM/YYYY",locale:{fromLabel:"Van",toLabel:"Tot",customRangeLabel:"Selecteer datumbereik",applyLabel:"Filteren",cancelLabel:"Sluiten"},startDate:moment().subtract("days",29),endDate:moment()},function(a,b){c=a,d=b,$("#reportrange span").html(a.format(e)+" - "+b.format(e)),k.update()}),$("#reportrange").on("shown",function(){$(this).addClass("focus")}),$("#reportrange").on("hidden",function(){$(this).removeClass("focus")}),$(".checkbox-filters").click(function(){k.update()}),$("#reportrange span").html(moment().subtract("days",29).format(e)+" - "+moment().format(e)),setTimeout(function(){window.location.hash&&k.update()},300)},update:function(){$("body").addClass("loading"),$("#map").trigger("dataloading");var e=a.getBounds().toBBoxString(),k=[];h={},i={},j=[],$.each($(".checkbox-filters"),function(a,b){$(b).is(":checked")&&k.push("'"+$(b).val()+"'")});var l="YYYY-MM-DD hh:mm:ss",m="SELECT DISTINCT ON (postal_code) postal_code, sum(case when  categoryId  != '' then 1 else 0 end) as count,  sum(case when  categoryId  = '1' then 1 else 0 end) as ct1, sum(case when  categoryId  = '2' then 1 else 0 end) as ct2, max(date) as date, the_geom FROM misdaad WHERE ST_Contains(ST_MakeEnvelope("+e+", 4326), the_geom) AND (date >= ('"+c.format(l)+"') AND date <= ('"+d.format(l)+"'))";k.length&&(m=m+" AND categoryId IN ("+k.join(",")+")"),m+=" GROUP BY the_geom, postal_code ORDER BY postal_code",$.get("http://danielbeeke.cartodb.com/api/v2/sql?q="+m+"&format=GeoJSON",function(c){g=0,f=0,b.clearLayers(),b=new L.MarkerClusterGroup({singleMarkerMode:!0,showCoverageOnHover:!1,iconCreateFunction:function(a){var b=0,c=0,d=[];$.each(a.getAllChildMarkers(),function(a,d){b+=d.data.properties.ct1,c+=d.data.properties.ct2});var e=b+c;return e>99&&d.push("greater-than-99"),e>999&&d.push("greater-than-999"),e>g&&(g=e),f>e&&(f=e),new L.DivIcon({html:'<div class="pieContainer '+d.join(" ")+'"><span class="pie" data-diameter="36" data-total="'+e+'">'+b+","+c+'</span><span class="number">'+e+"</span></div>"})}}),$.each(c.features,function(a,c){var d=c.properties.date,e=moment(d);e.lang("nl");var f=e.format("D-M-YYYY");-1==jQuery.inArray(f,j)&&j.push(f),h[d]||(h[d]=0),h[d]=h[d]+c.properties.ct1,i[d]||(i[d]=0),i[d]=i[d]+c.properties.ct2;var g=new L.Marker([c.geometry.coordinates[1],c.geometry.coordinates[0]]);g.data=c,b.addLayer(g)}),a.addLayer(b);var d=array_values(i),e=array_values(h),l=[];($("#poging-tot-woninginbraak:checked").length||0==k.length)&&l.push({name:"Inbraakpogingen",color:"#FFAD00",data:d}),($("#woninginbraak:checked").length||0==k.length)&&l.push({name:"Inbraken",color:"#ac0000",data:e});$("#chart").highcharts({title:{text:""},legend:{enabled:!1},credits:{enabled:!1},xAxis:{categories:j,labels:{enabled:!1}},yAxis:{title:{text:""},min:0},series:l});$.each($("span.pie"),function(){var a=this;$(this).peity("pie",{colours:["#ac0000","#FFAD00"],diameter:function(){var b=$(a).attr("data-total"),c=b-f,d=100/g*c;return 30+.5*d+"px"}})}),$("#map").trigger("dataload"),$("body").removeClass("loading")})}};k.init()});