$(function(){var a,b,c=moment().subtract("days",29),d=moment(),e="DD/MM/YYYY",f=0,g=0;L.Icon.Default.imagePath="/images";var h={init:function(){a=L.map("map",{attributionControl:!1,maxZoom:18}).setView([52.1,5],14),a.on("moveend",function(){h.update()}),L.control.locate().addTo(a);var f=L.Control.loading({separate:!0});a.addControl(f),b=new L.MarkerClusterGroup,new L.Control.GeoSearch({provider:new L.GeoSearch.Provider.Google,showMarker:!1,zoomLevel:14,position:"topright"}).addTo(a),$(".leaflet-control-geosearch").prependTo($("#filter-form > .form-group"));new L.Hash(a);$("#hide-content").click(function(){$("body").toggleClass("show-content")}),$("#leaflet-control-geosearch-qry").addClass("form-control").attr("placeholder","Zoek naar een plaats"),L.tileLayer("http://{s}.tilemill.studiofonkel.nl/style/{z}/{x}/{y}.png?id=tmstyle:///home/administrator/styles/dark.tm2").addTo(a),$("#reportrange").daterangepicker({opens:"left",ranges:{"Afgelopen 7 dagen":[moment().subtract("days",6),moment()],"Deze maand":[moment().startOf("month"),moment().endOf("month")],"Afgelopen 3 maanden":[moment().subtract("month",3).startOf("month"),moment().subtract("month",1).endOf("month")]},format:"DD/MM/YYYY",locale:{fromLabel:"Van",toLabel:"Tot",customRangeLabel:"Selecteer datumbereik",applyLabel:"Filteren",cancelLabel:"Sluiten"},startDate:moment().subtract("days",29),endDate:moment()},function(a,b){c=a,d=b,$("#reportrange span").html(a.format(e)+" - "+b.format(e)),h.update()}),$("#reportrange").on("shown",function(){$(this).addClass("focus")}),$("#reportrange").on("hidden",function(){$(this).removeClass("focus")}),$(".checkbox-filters").click(function(){h.update()}),$("#reportrange span").html(moment().subtract("days",29).format(e)+" - "+moment().format(e)),setTimeout(function(){window.location.hash&&h.update()},300)},update:function(){$("body").addClass("loading"),$("#map").trigger("dataloading");var e=a.getBounds().toBBoxString(),h=[];$.each($(".checkbox-filters"),function(a,b){$(b).is(":checked")&&h.push("'"+$(b).val()+"'")});var i="YYYY-MM-DD hh:mm:ss",j="SELECT DISTINCT ON (postal_code) postal_code, sum(case when  categoryId  != '' then 1 else 0 end) as count,  sum(case when  categoryId  = '1' then 1 else 0 end) as ct1, sum(case when  categoryId  = '2' then 1 else 0 end) as ct2, the_geom FROM misdaad WHERE ST_Contains(ST_MakeEnvelope("+e+", 4326), the_geom) AND (date >= ('"+c.format(i)+"') AND date <= ('"+d.format(i)+"'))";h.length&&(j=j+" AND categoryId IN ("+h.join(",")+")"),j+=" GROUP BY the_geom, postal_code ORDER BY postal_code",$.get("http://danielbeeke.cartodb.com/api/v2/sql?q="+j+"&format=GeoJSON",function(c){g=0,f=0,b.clearLayers(),b=new L.MarkerClusterGroup({singleMarkerMode:!0,showCoverageOnHover:!1,iconCreateFunction:function(a){var b=0,c=0,d=[];$.each(a.getAllChildMarkers(),function(a,d){b+=d.data.properties.ct1,c+=d.data.properties.ct2});var e=b+c;return e>99&&d.push("greater-than-99"),e>999&&d.push("greater-than-999"),e>g&&(g=e),f>e&&(f=e),new L.DivIcon({html:'<div class="pieContainer '+d.join(" ")+'"><span class="pie" data-diameter="36" data-total="'+e+'">'+b+","+c+'</span><span class="number">'+e+"</span></div>"})}}),$.each(c.features,function(a,c){var d=new L.Marker([c.geometry.coordinates[1],c.geometry.coordinates[0]]);d.data=c,b.addLayer(d)}),a.addLayer(b),$.each($("span.pie"),function(){var a=this;$(this).peity("pie",{colours:["#ac0000","#FFAD00"],diameter:function(){var b=$(a).attr("data-total"),c=b-f,d=100/g*c;return 30+.5*d+"px"}})}),$("#map").trigger("dataload"),$("body").removeClass("loading")})}};h.init()});